# macOS 磁盘空间分析工具

一个强大的命令行工具，用于分析 macOS 文件系统的磁盘空间使用情况。

## 功能特点

- 🔍 递归扫描目录，统计空间占用
- 📊 显示最大的文件和目录
- 📁 按文件类型（扩展名）分类统计
- 🌳 可视化目录树结构
- 📈 文件大小分布图
- 🎨 彩色终端输出
- 📄 支持导出 HTML/JSON 报告
- 🎬 **媒体文件分析**（视频、音频、图片等）
- 🧹 **可清理空间建议**（缓存、日志、临时文件等）
- 🔄 **重复文件检测**（优化的两阶段哈希算法）

## 安装

### 一键安装（推荐）

```bash
git clone https://github.com/openingax/disk-analyzer.git
cd disk-analyzer
./install.sh
source ~/.zshrc
```

安装脚本会自动：
- 创建 Python 虚拟环境
- 安装所需依赖
- 添加 `disk-analyzer` 命令到 shell

### 更新

```bash
disk-analyzer --update
```

### 卸载

```bash
./uninstall.sh
source ~/.zshrc
```

## 使用方法

### 基本用法

```bash
# 分析当前目录
disk-analyzer

# 分析指定目录
disk-analyzer ~/Downloads

# 分析整个磁盘（需要完全磁盘访问权限）
sudo disk-analyzer /
```

### 常用选项

```bash
# 限制扫描深度
disk-analyzer ~ --depth 3

# 显示前 30 个最大项
disk-analyzer . --top 30

# 只统计大于 10MB 的文件
disk-analyzer . --min-size 10MB

# 排除特定目录
disk-analyzer . --exclude node_modules,.git,__pycache__

# 生成 HTML 报告到指定路径
disk-analyzer . --output report.html

# 生成 JSON 报告
disk-analyzer . --json report.json
```

### 重复文件检测

```bash
# 检测重复文件
disk-analyzer ~/Downloads --find-duplicates

# 设置最小检测大小（默认 10KB）
disk-analyzer ~/Downloads --find-duplicates --dup-min-size 100KB
```

重复检测采用优化的两阶段哈希策略：
1. 按大小分组，排除 90%+ 无关文件
2. 计算部分哈希（首尾各 4KB）快速筛选
3. 仅对候选文件计算完整哈希

### 完整参数列表

| 参数 | 简写 | 说明 | 默认值 |
|------|------|------|--------|
| `path` | - | 要分析的目录路径 | `.` |
| `--depth` | `-d` | 最大扫描深度 | 无限制 |
| `--top` | `-n` | 显示前 N 个最大项 | 15 |
| `--min-size` | `-m` | 最小文件大小 | 0 |
| `--exclude` | `-e` | 排除的目录（逗号分隔） | - |
| `--output` | `-o` | 输出 HTML 报告 | - |
| `--json` | `-j` | 输出 JSON 报告 | - |
| `--tree-depth` | - | 目录树显示深度 | 2 |
| `--no-color` | - | 禁用彩色输出 | - |
| `--no-html` | - | 不生成 HTML 报告 | - |
| `--no-browser` | - | 不自动打开浏览器 | - |
| `--follow-symlinks` | - | 跟随符号链接 | 否 |
| `--show-errors` | - | 显示所有扫描错误 | - |
| `--find-duplicates` | - | 检测重复文件 | - |
| `--dup-min-size` | - | 重复检测最小文件大小 | 10KB |
| `--update` | - | 更新工具到最新版本 | - |
| `--version` | `-v` | 显示版本信息 | - |

## HTML 报告功能

生成的 HTML 报告包含：

- 📊 **可视化图表**（ECharts）
  - 文件类型分布饼图
  - 媒体文件占比饼图
  - 空间占用 Treemap（支持点击下钻）
  - 文件大小分布柱状图
- 🎬 **媒体文件分析** - 按类型统计视频、音频、图片等
- 🧹 **可清理空间建议** - 识别缓存、日志、临时文件等
- 🌳 **交互式目录树** - 可折叠/展开的目录结构
- 📑 **标签页切换** - 最大目录、最大文件、文件类型

## 完全磁盘访问权限

要扫描系统的某些受保护目录（如 `/Library`、`/System`），需要授予终端完全磁盘访问权限：

1. 打开 **系统设置** > **隐私与安全性** > **完全磁盘访问权限**
2. 点击 **+** 添加 **终端.app** (或你使用的终端应用)
3. 重启终端

## 输出示例

### 终端输出

```
===========================================================
  磁盘空间分析报告
===========================================================

  📁 扫描路径: /Users/username/Downloads
  💾 总大小:   15.3 GB
  📄 文件数:   1,234
  📂 目录数:   89

📂 最大的目录
------------------------------------------------------------
   1.   15.3 GB [████████████████████] 100.0%  /Users/username/Downloads
   2.    8.2 GB [██████████░░░░░░░░░░]  53.6%  .../Videos
   3.    4.1 GB [█████░░░░░░░░░░░░░░░]  26.8%  .../Archives
```

### 重复文件检测

```
============================================================
� 正在检测重复文件...
============================================================

✅ 检测完成! 耗时: 2.3 秒

   发现 15 组重复文件
   涉及 42 个文件
   💾 可释放空间: 1.2 GB

�📄 最大的重复文件组:
------------------------------------------------------------
   1. [3 份] 256.0 MB (可释放 512.0 MB)
     ├── /Users/x/Downloads/movie.mp4
     ├── /Users/x/Backup/movie.mp4
     └── /Users/x/Desktop/movie.mp4
```

## 许可证

MIT License

